(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{390:function(e,t,s){"use strict";s.r(t);var a=s(26),r=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"node新手课（12）手机登录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#node新手课（12）手机登录"}},[e._v("#")]),e._v(" node新手课（12）手机登录")]),e._v(" "),s("h2",{attrs:{id:"简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[e._v("#")]),e._v(" 简介")]),e._v(" "),s("p",[e._v("上节课我们讲了微信小程序登录，今天我们来讲绑定手机号。")]),e._v(" "),s("h2",{attrs:{id:"需求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#需求"}},[e._v("#")]),e._v(" 需求")]),e._v(" "),s("p",[e._v("用户微信登录后绑定自己的手机号。")]),e._v(" "),s("h2",{attrs:{id:"功能流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#功能流程"}},[e._v("#")]),e._v(" 功能流程")]),e._v(" "),s("p",[e._v("通过用户凭据token获取到用户id，在数据库user表中找到用户记录，把前端传来的手机号更新到记录中。")]),e._v(" "),s("h2",{attrs:{id:"中间件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#中间件"}},[e._v("#")]),e._v(" 中间件")]),e._v(" "),s("p",[e._v("sir-koa目录下新建middleware目录，存放项目的中间件。")]),e._v(" "),s("blockquote",[s("p",[e._v("middleware/auth.js")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("const response = require('../app/core/response')\nconst Redis = require('../app/model/redis')\nconst redis = new Redis()\nconst resp = new response()\nmodule.exports = async (ctx, next) => {\n     let token = ctx.request.headers[\"token\"];\n    // 解码\n    let user = await redis.get(token)\n    if (!token || !user) {\n        //过期\n        ctx.body = resp.fail(10001, \"请重新登录\")\n        return\n    }\n    \n    ctx.state.userId = user.userId\n    // 未过期\n    await next();\n}\n")])])]),s("blockquote",[s("p",[e._v("middleware/jsonHeader.js")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("module.exports = async (ctx, next) => {\n    ctx.response.type = 'application/json';\n    await next();\n  }\n")])])]),s("p",[e._v("绑定中间件。")]),e._v(" "),s("blockquote",[s("p",[e._v("app.js")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("const jsonHeader = require('./middleware/jsonHeader')\napp.use(jsonHeader);\n// routes\n")])])]),s("blockquote",[s("p",[e._v("routes/user.js")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("const auth = require('../middleware/auth')\n// 手机号登录\nrouter.post('/login', auth,function (ctx, next) {\n  return userApi.login(ctx) \n})\n")])])]),s("h2",{attrs:{id:"手机号登录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#手机号登录"}},[e._v("#")]),e._v(" 手机号登录")]),e._v(" "),s("p",[e._v("客户端传手机号给到服务端，服务端更新用户信息。")]),e._v(" "),s("blockquote",[s("p",[e._v("model/usermodel.js")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('const updateUser = async(userId,phone)=>{\n    let sql = "update  `user` set phone=? where id=?"\n    return await mysql.exec(sql,[phone,userId]) \n}\n')])])]),s("blockquote",[s("p",[e._v("api/user.js")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("const login = async(ctx) => {\n    const phone = ctx.request.body.phone\n    const userId = ctx.state.userId\n    await userModel.updateUser(userId,phone)\n    ctx.body = resp.succeed()\n    return\n}\n")])])]),s("h2",{attrs:{id:"运行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#运行"}},[e._v("#")]),e._v(" 运行")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('POST http://localhost:3000/user/login\n\n{\n    "phone":""\n}\n')])])]),s("p",[s("img",{attrs:{src:"https://cdn.guojiang.club/Fo6qftIGMQq8uM7ANRdWs9Kskow5",alt:""}})]),e._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),s("p",[e._v("绑定手机号就讲完了，你掌握了吗？有问题欢迎到群里和志同道合的小伙伴一起交流。")]),e._v(" "),s("p",[e._v("下节课我们讲解用户信息展示接口，继续加油吧，Let's go！")])])}),[],!1,null,null,null);t.default=r.exports}}]);