(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{432:function(e,s,t){"use strict";t.r(s);var n=t(49),r=Object(n.a)({},(function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"node新手课（11）微信小程序登录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#node新手课（11）微信小程序登录"}},[e._v("#")]),e._v(" node新手课（11）微信小程序登录")]),e._v(" "),t("h2",{attrs:{id:"简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[e._v("#")]),e._v(" 简介")]),e._v(" "),t("p",[e._v("上节课我们讲了 nodejs 操作 redis，今天我们来讲解微信小程序登录。")]),e._v(" "),t("h2",{attrs:{id:"代码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#代码"}},[e._v("#")]),e._v(" 代码")]),e._v(" "),t("p",[e._v("微信服务端接口文档地址")]),e._v(" "),t("p",[e._v("https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html")]),e._v(" "),t("blockquote",[t("p",[e._v("简而言之，小程序前端调用 wx.login 获取 code, 传给服务端。服务端携带 code 和 appid，secret 发给微信服务器，获取到用户 openid 和 sessionkey。")])]),e._v(" "),t("p",[e._v("新增小程序的配置文件")]),e._v(" "),t("blockquote",[t("p",[e._v("routes/user.js")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("router.post('/wechatlogin',function (ctx, next) {\n  return userApi.wechatLogin(ctx) \n})\n")])])]),t("blockquote",[t("p",[e._v("config/miniapp.js")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const appid = ''\nconst secret = ''\n\nmodule.exports={\n    appid,secret\n}\n")])])]),t("p",[e._v("api/user.js 文件，里面写用户 api 的相关方法。model/usermodel.js 文件，里面写用户模型相关方法。")]),e._v(" "),t("blockquote",[t("p",[e._v("api/user.js")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('const miniappConfig = require(\'../../config/miniapp\')\nconst koa2Req = require(\'koa2-request\')\nconst response = require(\'../core/response\')\nconst userModel = require(\'../model/usermodel\')\nconst request = require(\'koa2-request\')\nconst { md5 } = require(\'../util/cryp\')\nconst Redis = require(\'../model/redis\')\nconst redis = new Redis()\nconst resp = new response()\n\nconst wechatLogin = async (ctx) => {\n\n    const code = ctx.request.body.code\n    const body = await wxUser(code)\n\n    if (body.errcode > 0) {\n        ctx.body = resp.fail(10001, body.errmsg)\n        return\n    }\n    let userId = await userModel.getUserByOpenid(body.openid)\n    if(userId == 0){\n        userId = await userModel.createUser(body.openid)\n    }\n    const token = md5(body.openid)\n    redis.set(token,{ "openid": body.openid,"userId":userId })\n    ctx.body = resp.setData({ "token": token })\n    return\n}\nconst wxUser = async (code) => {\n    const appid = miniappConfig.appid\n    const secret = miniappConfig.secret\n    const loginUrl = "https://api.weixin.qq.com/sns/jscode2session?appid=" + appid + "&secret=" + secret + "&js_code=" + code + "&grant_type=authorization_code"\n    const wxresult = await koa2Req(loginUrl).catch((err) => {\n        console.log("err", err);\n    });\n    return JSON.parse(wxresult.body)\n}\n')])])]),t("blockquote",[t("p",[e._v("model/usermodel.js")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('const mysql = require("./mysql")\n\nconst getUserByOpenid = async(openid)=>{\n    let sql = "select id from user where openid=?"\n    return await mysql.exec(sql,[openid]) \n}\nconst createUser= async(openid)=>{\n    let sql = "insert into  `user` (openid)values(?) "\n    const insertData = await mysql.exec(sql,[openid]) \n    return insertData.insertId\n}\nmodule.exports = {\n    getUserByOpenid,createUser\n}\n')])])]),t("h2",{attrs:{id:"运行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#运行"}},[e._v("#")]),e._v(" 运行")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('POST http://localhost:3000/user/wechatlogin\n\n{\n    "code":""\n}\n')])])]),t("p",[t("img",{attrs:{src:"https://cdn.guojiang.club/Fo6qftIGMQq8uM7ANRdWs9Kskow5",alt:""}}),e._v("\ntoken 是客户端调用用户相关接口需要携带的凭据，服务端通过 token 识别用户身份信息，相当于 session。")]),e._v(" "),t("h2",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),t("p",[e._v("微信小程序登录就讲完了，你掌握了吗？有问题欢迎到群里和志同道合的小伙伴一起交流。")]),e._v(" "),t("p",[e._v("下节课我们讲解手机号登录，继续加油吧，Let's go！")])])}),[],!1,null,null,null);s.default=r.exports}}]);